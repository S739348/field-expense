<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sessions & Expenses - Acme Co</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#137fec",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: {
                        display: ["Inter"],
                    },
                },
            },
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow-x: hidden;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-approved { background: #dcfce7; color: #166534; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #dbeafe; color: #1e40af; }
        
        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -10px rgba(0,0,0,0.15);
        }
        
        .glassmorphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glassmorphism {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
    <script>
        (function(){
            try{
                const u = localStorage.getItem('loggedUser');
                if (!u) {
                    window.location.href = 'login.html';
                }
            }catch(e){/* ignore */}
        })();
    </script>

    <!-- Fixed Header - No margin, full width -->
    <header class="fixed top-0 left-0 right-0 z-50 glassmorphism border-b border-gray-200 dark:border-gray-800">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-primary" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_6_319)">
                        <path d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z" fill="currentColor"></path>
                    </g>
                    <defs><clipPath id="clip0_6_319"><rect fill="white" height="48" width="48"></rect></clipPath></defs>
                </svg>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">Acme Co</h1>
            </div>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-medium text-gray-600 hover:text-primary transition-colors dark:text-gray-300 dark:hover:text-primary" href="dashboard.html">Dashboard</a>
                <a class="text-sm font-bold text-primary border-b-2 border-primary pb-1" href="expenses.html">Sessions</a>
                <a class="text-sm font-medium text-gray-600 hover:text-primary transition-colors dark:text-gray-300 dark:hover:text-primary" href="user.html">Employees</a>
                <a class="text-sm font-medium text-gray-600 hover:text-primary transition-colors dark:text-gray-300 dark:hover:text-primary" href="categories.html">Categories</a>
            </nav>
            <div class="flex items-center gap-3">
                <button class="rounded-full p-2 text-gray-600 hover:bg-gray-100 transition-colors dark:text-gray-400 dark:hover:bg-gray-800">
                    <span class="material-symbols-outlined">notifications</span>
                </button>
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white font-semibold">
                    A
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content - with top padding for fixed header -->
    <div class="pt-20 px-6 pb-6 max-w-7xl mx-auto">
        
        <!-- Search & Filter Bar -->
        <div class="mb-6 space-y-4">
            <div class="relative">
                <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                <input id="searchInput" type="text" placeholder="Search sessions, users, descriptions, categories..." 
                    class="w-full pl-12 pr-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all" />
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-gray-500 text-xl">calendar_month</span>
                    <input id="expenseDateRange" type="text" readonly placeholder="Select date range" 
                        class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 py-2 px-4 text-sm text-gray-900 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/20 cursor-pointer min-w-[240px] transition-all" />
                </div>
                <button id="expenseFilterBtn" class="rounded-lg bg-primary px-6 py-2 text-white text-sm font-semibold hover:bg-primary/90 transition-all shadow-sm hover:shadow">
                    Apply Filter
                </button>
                <button id="expenseFilterCancelBtn" class="rounded-lg border border-gray-300 dark:border-gray-600 px-6 py-2 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                    Clear
                </button>
                <div class="ml-auto text-sm text-gray-500 dark:text-gray-400">
                    <span class="material-symbols-outlined text-lg align-middle">info</span>
                    <span class="align-middle ml-1">Sessions grouped with expenses</span>
                </div>
            </div>
        </div>

        <!-- Sessions Container -->
        <div id="sessionsContainer" class="space-y-4 max-h-[calc(100vh-280px)] overflow-y-auto scrollbar-hide pr-2">
            <!-- Session cards will be injected here -->
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 backdrop-blur-sm z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full overflow-hidden animate-in">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-primary/5 to-transparent">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Details</h3>
                <button id="modalClose" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                <div id="sessionBlock" class="space-y-3 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl">
                    <!-- session fields -->
                </div>
                <div id="userBlock" class="space-y-3 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl">
                    <!-- user fields -->
                </div>
                <div id="expenseBlock" class="space-y-3 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl">
                    <!-- expense details -->
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script>
        const today = new Date();
        const minDate = new Date(today.getFullYear() - 2, today.getMonth(), today.getDate());
        window.picker = new Litepicker({
            element: document.getElementById('expenseDateRange'),
            singleMode: false,
            numberOfMonths: 2,
            numberOfColumns: 2,
            format: 'DD-MM-YYYY',
            minDate: minDate,
            maxDate: today,
            autoApply: false,
            allowRepick: true,
            dropdowns: { minYear: minDate.getFullYear(), maxYear: today.getFullYear(), months: true, years: true },
            setup: (picker) => {
                picker.on('selected', (start, end) => {
                    if (end && start && end.getTime() < start.getTime()) {
                        picker.setDateRange(end, start);
                    }
                });
            }
        });
    </script>
    <script>
    (async function(){
        const container = document.getElementById('sessionsContainer');
        const modal = document.getElementById('detailModal');
        const modalClose = document.getElementById('modalClose');
        const sessionBlock = document.getElementById('sessionBlock');
        const userBlock = document.getElementById('userBlock');
        const expenseBlock = document.getElementById('expenseBlock');

        let sessionsData = [];

        function parseDateDMY(s) {
            if (!s) return null;
            const parts = s.trim().split('-');
            if (parts.length !== 3) return null;
            const d = parseInt(parts[0],10);
            const m = parseInt(parts[1],10);
            const y = parseInt(parts[2],10);
            if (Number.isNaN(d) || Number.isNaN(m) || Number.isNaN(y)) return null;
            return new Date(y, m-1, d);
        }

        function getField(o, ...keys) {
            if (!o) return null;
            for (const k of keys) {
                if (k in o && o[k] !== undefined && o[k] !== null) return o[k];
            }
            return null;
        }

        function isPending(status) {
            if (status === null || status === undefined) return true;
            const s = String(status).trim();
            if (s.length === 0) return true;
            return s.toLowerCase() === 'pending';
        }

        function getStatusBadge(status) {
            const s = String(status || 'pending').toLowerCase();
            let className = 'status-badge status-pending';
            if (s === 'approved') className = 'status-badge status-approved';
            else if (s === 'rejected') className = 'status-badge status-rejected';
            else if (s === 'paid') className = 'status-badge status-paid';
            return `<span class="${className}">${escapeHtml(status || 'Pending')}</span>`;
        }

        function renderSessions(list) {
            if (!list || list.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600">folder_off</span>
                        <p class="mt-4 text-gray-500 dark:text-gray-400">No sessions found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            list.forEach(s => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer overflow-hidden border border-gray-100 dark:border-gray-700 card-hover';
                const user = s.user || {};
                
                const headerHtml = `
                    <div class="p-5 border-b border-gray-100 dark:border-gray-700">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">${escapeHtml(s.sessionName || 'Session')}</h3>
                                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="material-symbols-outlined text-base">schedule</span>
                                    <span>${escapeHtml(formatDateTime(s.start_time || s.startTime))} — ${escapeHtml(formatDateTime(s.end_time || s.endTime))}</span>
                                </div>
                            </div>
                            <div class="text-right space-y-1">
                                <div class="flex items-center justify-end gap-1 text-sm">
                                    <span class="material-symbols-outlined text-base text-primary">directions_car</span>
                                    <span class="font-semibold text-gray-900 dark:text-white">${formatDistance(s.total_distance || s.totalDistance)}</span>
                                </div>
                                ${getStatusBadge(s.status)}
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 text-sm">
                            ${user.name ? `<div class="flex items-center gap-2 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-base">person</span>
                                <span class="font-medium">${escapeHtml(user.name)}</span>
                            </div>` : ''}
                            ${user.email ? `<div class="flex items-center gap-2 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-base">email</span>
                                <span>${escapeHtml(user.email)}</span>
                            </div>` : ''}
                            ${user.role ? `<div class="flex items-center gap-2 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-base">badge</span>
                                <span class="font-medium text-primary">${escapeHtml(user.role)}</span>
                            </div>` : ''}
                            ${user.manager ? `<div class="flex items-center gap-2 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-base">supervisor_account</span>
                                <span class="font-medium">${escapeHtml(user.manager.name || 'Manager')}</span>
                            </div>` : ''}
                        </div>
                    </div>
                `;
                card.innerHTML = headerHtml;

                const expWrap = document.createElement('div');
                expWrap.className = 'p-5';
                
                if (s.expenses && s.expenses.length > 0) {
                    const expTable = document.createElement('div');
                    expTable.className = 'space-y-2';
                    
                    (s.expenses || []).forEach(exp => {
                        const mgr = exp.managerStatus || 'Pending';
                        const hr = exp.hrStatus || 'Pending';
                        const fin = exp.financeStatus || 'Pending';
                        const pay = getField(exp, 'paymentStatus', 'payment_status') || 'unpaid';
                        
                        const expRow = document.createElement('div');
                        expRow.className = 'flex items-start justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-900/50 hover:bg-gray-100 dark:hover:bg-gray-900 transition-colors';
                        expRow.innerHTML = `
                            <div class="flex-1 space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm text-primary">category</span>
                                    <span class="font-semibold text-gray-900 dark:text-white">${escapeHtml(exp.category || '')}</span>
                                    <span class="text-lg font-bold text-primary">₹${escapeHtml(String(exp.amount ?? ''))}</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${escapeHtml(exp.description || '')}</p>
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <span class="material-symbols-outlined text-xs">schedule</span>
                                    Created: ${escapeHtml(formatDateTime(exp.createdAt))}
                                </div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <div class="text-xs"><strong>Manager:</strong> ${getStatusBadge(mgr)}</div>
                                    <div class="text-xs"><strong>HR:</strong> ${getStatusBadge(hr)}</div>
                                    <div class="text-xs"><strong>Finance:</strong> ${getStatusBadge(fin)}</div>
                                    <div class="text-xs"><strong>Payment:</strong> ${getStatusBadge(pay)}</div>
                                </div>
                            </div>
                            <div class="actions-cell flex flex-wrap gap-2 ml-4"></div>
                        `;
                        expTable.appendChild(expRow);
                    });
                    expWrap.appendChild(expTable);
                } else {
                    expWrap.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No expenses recorded</p>';
                }
                
                card.appendChild(expWrap);
                container.appendChild(card);
            });

            container.querySelectorAll('.card-hover').forEach((card, idx) => {
                const s = list[idx];
                card.addEventListener('click', (ev) => {
                    if (ev.target.closest('.actions-cell') || ev.target.tagName === 'BUTTON') return;
                    openModalForSession(s);
                });
            });

            const logged = (() => { try { return JSON.parse(localStorage.getItem('loggedUser')); } catch(e) { return null; } })();
            
            container.querySelectorAll('.actions-cell').forEach((actionsCell, globalIndex) => {
                let expenseIndex = 0;
                for (let i = 0; i < globalIndex; i++) {
                    const prevSession = list[Math.floor(i / (list.reduce((sum, s) => sum + (s.expenses?.length || 0), 0) / globalIndex))];
                    if (prevSession && prevSession.expenses) expenseIndex++;
                }
                
                const sessionIndex = list.findIndex(s => s.expenses && s.expenses.some((_, i) => {
                    const localExp = expenseIndex--;
                    return localExp === 0;
                }));
                
                if (sessionIndex === -1) return;
                const s = list[sessionIndex];
                if (!s.expenses) return;
                
                const expIndex = globalIndex % (s.expenses.length || 1);
                const exp = s.expenses[expIndex];
                if (!exp) return;

                if (!logged || !logged.role) return;
                const role = String(logged.role || '').toUpperCase();
                
                function createBtn(text, icon, cls, onClick) {
                    const b = document.createElement('button');
                    b.className = cls + ' flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-semibold transition-all shadow-sm hover:shadow whitespace-nowrap';
                    b.innerHTML = `<span class="material-symbols-outlined text-sm">${icon}</span><span>${text}</span>`;
                    b.addEventListener('click', onClick);
                    return b;
                }
                
                const expId = getField(exp, 'expenseId', 'expense_id', 'id');
                const approverId = getField(logged, 'userId', 'user_id', 'id');

                const mgrStatus = String(exp.managerStatus || '').trim().toLowerCase();
                const hrStatus = String(exp.hrStatus || '').trim().toLowerCase();
                const finStatus = String(exp.financeStatus || '').trim().toLowerCase();
                const anyRejected = [mgrStatus, hrStatus, finStatus].some(s => s === 'rejected');
                const paidStatus = String((getField(exp, 'paymentStatus', 'payment_status') || '')).toLowerCase();

                if (role === 'MANAGER' && isPending(exp.managerStatus) && !anyRejected && paidStatus !== 'paid') {
                    const approve = createBtn('Approve', 'check_circle', 'bg-green-500 text-white hover:bg-green-600', async (ev)=>{ ev.stopPropagation(); await doApprove(expId, approverId, 'MANAGER', 'APPROVED', null, actionsCell); });
                    const reject = createBtn('Reject', 'cancel', 'bg-red-500 text-white hover:bg-red-600', async (ev)=>{ ev.stopPropagation(); await doApprove(expId, approverId, 'MANAGER', 'REJECTED', null, actionsCell); });
                    actionsCell.appendChild(approve);
                    actionsCell.appendChild(reject);
                }
                
                if (role === 'HR' && isPending(exp.hrStatus) && !anyRejected && paidStatus !== 'paid' && mgrStatus === 'approved') {
                    const approve = createBtn('Approve', 'check_circle', 'bg-green-500 text-white hover:bg-green-600', async (ev)=>{ ev.stopPropagation(); await doApprove(expId, approverId, 'HR', 'APPROVED', null, actionsCell); });
                    const reject = createBtn('Reject', 'cancel', 'bg-red-500 text-white hover:bg-red-600', async (ev)=>{ ev.stopPropagation(); await doApprove(expId, approverId, 'HR', 'REJECTED', null, actionsCell); });
                    actionsCell.appendChild(approve);
                    actionsCell.appendChild(reject);
                }
                
                if (role === 'FINANCE') {
                    if (isPending(exp.financeStatus) && !anyRejected && paidStatus !== 'paid' && mgrStatus === 'approved' && hrStatus === 'approved') {
                        const approve = createBtn('Approve', 'check_circle', 'bg-green-500 text-white hover:bg-green-600', async (ev)=>{ ev.stopPropagation(); await doApprove(expId, approverId, 'FINANCE', 'APPROVED', null, actionsCell); });
                        const reject = createBtn('Reject', 'cancel', 'bg-red-500 text-white hover:bg-red-600', async (ev)=>{ ev.stopPropagation(); await doApprove(expId, approverId, 'FINANCE', 'REJECTED', null, actionsCell); });
                        actionsCell.appendChild(approve);
                        actionsCell.appendChild(reject);
                    }
                    if (finStatus === 'approved' && paidStatus !== 'paid') {
                        const paidBtn = createBtn('Mark Paid', 'payments', 'bg-primary text-white hover:bg-primary/90', async (ev)=>{ ev.stopPropagation(); await doApprove(expId, approverId, 'FINANCE', 'APPROVED', 'paid', actionsCell); });
                        actionsCell.appendChild(paidBtn);
                    }
                }
            });
        }

        async function load(range) {
            container.innerHTML = '<div class="p-12 text-center"><div class="inline-block w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div><p class="mt-4 text-gray-500">Loading sessions...</p></div>';
            try {
                const logged = (() => { try { return JSON.parse(localStorage.getItem('loggedUser')); } catch(e) { return null; } })();
                const userId = logged ? logged.userId : null;
                if (!userId) {
                    container.innerHTML = '<div class="p-6 text-center text-red-500">Please login to view sessions</div>';
                    return;
                }
                
                const url = `/api/sessions?userId=${userId}` + (range ? `&range=${encodeURIComponent(range)}` : '');
                const res = await fetch(url);
                if (!res.ok) {
                    container.innerHTML = '<div class="p-6 text-center text-red-500">Failed to load sessions</div>';
                    return;
                }

                const hdrRange = res.headers.get('X-Range');
                const hdrStart = res.headers.get('X-Start-Date');
                const hdrEnd = res.headers.get('X-End-Date');
                if (hdrRange) {
                    document.getElementById('expenseDateRange').value = hdrRange;
                    localStorage.setItem('expensesDateRange', hdrRange);
                    try {
                        const sdt = hdrStart ? new Date(hdrStart) : null;
                        const edt = hdrEnd ? new Date(hdrEnd) : null;
                        if (sdt && edt && !isNaN(sdt.getTime()) && !isNaN(edt.getTime())) {
                            window.picker.setDateRange(sdt, edt);
                        } else {
                            const parts = hdrRange.split('-');
                            if (parts.length >= 2) {
                                const a = parseDateDMY(parts[0].trim());
                                const b = parseDateDMY(parts[1].trim());
                                if (a && b) window.picker.setDateRange(a, b);
                            }
                        }
                    } catch(e){}
                }

                const data = await res.json();
                const sessions = data.sessions || [];
                const userRole = data.role;
                
                // Filter user data based on role
                const filteredSessions = sessions.map(session => {
                    const filteredSession = { ...session };
                    
                    if (session.user) {
                        if (userRole === 'MANAGER') {
                            // Manager: don't show manager field in user data
                            const { manager, ...userWithoutManager } = session.user;
                            filteredSession.user = userWithoutManager;
                        } else if (userRole === 'FIELD_EMPLOYEE_FULLTIME' || userRole === 'FIELD_EMPLOYEE_VENDOR') {
                            // Field employees: don't show user details except manager
                            filteredSession.user = {
                                manager: session.user.manager
                            };
                        }
                        // For other roles (ADMIN, HR, FINANCE), show all user data
                    }
                    
                    return filteredSession;
                });
                
                sessionsData = filteredSessions;
                renderSessions(sessionsData);

            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="p-6 text-center text-red-600">Failed to load sessions</div>';
            }
        }

        function openModalForSession(s) {
            document.getElementById('modalTitle').textContent = 'Session Details';
            sessionBlock.innerHTML = `
                <h4 class="font-bold text-gray-900 dark:text-white mb-3">Session Information</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-500">Name:</span><span class="font-semibold">${escapeHtml(s.sessionName || s.session_name || '')}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Start:</span><span class="font-semibold">${escapeHtml(formatDateTime(s.start_time || s.startTime))}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">End:</span><span class="font-semibold">${escapeHtml(formatDateTime(s.end_time || s.endTime))}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Distance:</span><span class="font-semibold">${formatDistance(s.total_distance || s.totalDistance)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Status:</span>${getStatusBadge(s.status || s.session_status)}</div>
                    <div class="flex justify-between"><span class="text-gray-500">Location:</span><span class="font-semibold">${s.start_lat || s.latitude ? `${(s.start_lat || s.latitude).toFixed(6)}, ${(s.start_lon || s.longitude).toFixed(6)}` : 'N/A'}</span></div>
                </div>
            `;
            if (s.user) {
                let userInfo = '<h4 class="font-bold text-gray-900 dark:text-white mb-3">User Information</h4><div class="space-y-2 text-sm">';
                if (s.user.name) userInfo += `<div class="flex justify-between"><span class="text-gray-500">Name:</span><span class="font-semibold">${escapeHtml(s.user.name)}</span></div>`;
                if (s.user.email) userInfo += `<div class="flex justify-between"><span class="text-gray-500">Email:</span><span class="font-semibold">${escapeHtml(s.user.email)}</span></div>`;
                if (s.user.role) userInfo += `<div class="flex justify-between"><span class="text-gray-500">Role:</span><span class="font-semibold text-primary">${escapeHtml(s.user.role)}</span></div>`;
                if (s.user.manager) userInfo += `<div class="flex justify-between"><span class="text-gray-500">Manager:</span><span class="font-semibold">${escapeHtml(s.user.manager.name || 'Manager')}</span></div>`;
                userInfo += '</div>';
                userBlock.innerHTML = userInfo;
            } else {
                userBlock.innerHTML = '<div class="text-gray-500">No user data available</div>';
            }
            expenseBlock.innerHTML = '<h4 class="font-bold text-gray-900 dark:text-white">Expenses: <span class="text-primary">' + ((s.expenses||[]).length) + '</span></h4>';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        modalClose.addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });
        modal.addEventListener('click', (ev) => { if (ev.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } });

        function escapeHtml(s) { if (s === null || s === undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
        function formatDateTime(v) { if (!v) return ''; try { const d = new Date(v); return d.toLocaleString(); } catch(e) { return String(v); } }
        function formatDistance(meters) {
            if (meters === null || meters === undefined) return '0 Km';
            const n = Number(meters);
            if (Number.isNaN(n) || n <= 0) return '0 Km';
            const km = n / 1000;
            let s = km.toFixed(2).replace(/\.0+$/,'');
            s = s.replace(/(\.[0-9]*?)0+$/,'$1').replace(/\.$/, '');
            return s + ' Km';
        }

        document.getElementById('expenseFilterBtn').addEventListener('click', () => {
            const v = document.getElementById('expenseDateRange').value;
            localStorage.setItem('expensesDateRange', v);
            load(v);
        });
        document.getElementById('expenseFilterCancelBtn').addEventListener('click', () => {
            localStorage.removeItem('expensesDateRange');
            document.getElementById('expenseDateRange').value = '';
            try { window.picker.setDateRange(null, null); } catch(e){}
            load(null);
        });

        const searchInput = document.getElementById('searchInput');
        let searchTimeout = null;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const q = searchInput.value.trim().toLowerCase();
                if (!q) return renderSessions(sessionsData);
                const filtered = sessionsData.filter(s => {
                    const user = s.user || {};
                    const combined = [s.sessionName, s.startTime, s.endTime, s.status, user.name, user.email, JSON.stringify(s.expenses || [])].join(' ').toLowerCase();
                    return combined.includes(q);
                });
                renderSessions(filtered);
            }, 250);
        });

        async function doApprove(expenseId, approverId, role, status, paymentStatus, actionsCell) {
            try {
                const payload = { expenseId: expenseId, approverId: approverId, role: role, status: status };
                if (paymentStatus) payload.paymentStatus = paymentStatus;
                const headers = { 'Content-Type': 'application/json' };
                let uid = approverId;
                if (!uid) {
                    try { const lu = JSON.parse(localStorage.getItem('loggedUser')); if (lu) uid = getField(lu, 'userId', 'user_id', 'id'); } catch(e){}
                }
                if (uid !== undefined && uid !== null) {
                    const n = Number(uid);
                    if (!Number.isNaN(n)) headers['X-User-Id'] = String(n);
                }
                const res = await fetch('/api/expenses/approve', {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const text = await res.text();
                    alert('Action failed: ' + text);
                    return;
                }
                const data = await res.json();
                if (actionsCell) {
                    const actions = actionsCell.querySelectorAll('button');
                    actions.forEach(b => { b.disabled = true; b.classList.add('opacity-50', 'cursor-not-allowed'); });
                }
                load(document.getElementById('expenseDateRange').value || null);
            } catch (err) {
                console.error(err);
                alert('Network error: ' + err.message);
            }
        }

        const saved = localStorage.getItem('expensesDateRange');
        if (saved) {
            document.getElementById('expenseDateRange').value = saved;
            try { const parts = saved.split('-'); if (parts.length>=2) { const a = parseDateDMY(parts[0].trim()); const b = parseDateDMY(parts[1].trim()); if (a && b) window.picker.setDateRange(a, b); } } catch(e){}
            load(saved);
        } else {
            load(null);
        }

    })();
    </script>
</body>
</html>